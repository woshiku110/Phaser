<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Loading single asset</title>
    <script src="phaser.min.js"></script>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    // width:  window.innerWidth * window.devicePixelRatio,
    // height: window.innerHeight * window.devicePixelRatio,

    scale: {
        mode: Phaser.Scale.FIT,
        // parent: 'phaser-example',
        autoCenter: Phaser.Scale.FIT,
        width: 750,
        height: 1624,
    },
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 300 },
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

let cannon = null
let cursors = null
let bulletEmitter = null
let planet = null
let gameOver = false

let game = new Phaser.Game(config);

function preload () {
    this.load.image('background', 'assets/start_bg.jpg');
    this.load.image('ground', 'assets/ground_real.png');
    this.load.image('cannon', 'assets/cannon.png');
    this.load.image('bullet', 'assets/bullet.png');
    this.load.image('smoke', 'assets/smoke.png');
    this.load.image('green', 'assets/green_ball.png');

    // this.load.spritesheet('dude', 'assets/dude.png', { frameWidth: 32, frameHeight: 48 });

    this.scale.startFullscreen();
}

function create () {
    this.add.image(750 / 2, 1624 / 2, 'background')
    // this.add.image(750 / 2, 1020, 'ground') // static adding
    // this.add.image(750 / 2, 950, 'cannon') // static adding

    ground = this.physics.add.staticGroup();
    ground.create(750 / 2, 1020, 'ground');

    cannon = this.physics.add.image(750 / 2 + 200, 940, 'cannon')
    cannon.setCollideWorldBounds(true)

    this.physics.add.collider(cannon, ground);

    // Keyboard Input Events
    cursors = this.input.keyboard.createCursorKeys();

    // -------- add emitter start -----
    var particles = this.add.particles('bullet');

    // var emitter = particles.createEmitter({ // vertex emitter
    //     // x: 750 / 2,
    //     // y: 1624 / 2,
    //     x: 0,
    //     y: -60,
    //     angle: { min: 180, max: 360 },
    //     speed: 400,
    //     gravityY: 350,
    //     lifespan: 4000,
    //     quantity: 6,
    //     scale: { start: 0.1, end: 1 },
    //     blendMode: 'NORMAL' // 'ADD' is not displayed ???
    //     follow: cannon
    // });

    var bulletDeath = {
        contains: function (x, y) {
            var hit = planet && planet.body && planet.body.hitTest(x, y);

            if (hit) { 
                planet.destroy()
            }

            return hit;
        }
    }

    bulletEmitter = particles.createEmitter({ // vertex emitter
        // x: 750 / 2,
        // y: 1624 / 2,
        x: 0,
        y: -70,
        angle: -90,
        speed: 800,
        gravityY: 10,
        lifespan: 4000,
        quantity: 1,
        scale: 1,
        frequency: 80, // the larger the slower
        blendMode: 'NORMAL',
        follow: cannon,
        deathZone: { type: 'onEnter', source: bulletDeath } // disappear on enter
    });


    // emitter.startFollow(cannon)
    // -------- add emitter end -----

    // bullet smoke
    smoke = this.make.sprite({
        x: 750 / 2,
        y: 800,
        key: 'smoke',
        add: true
    });

    // planets
    planet = this.physics.add.image(200, 200, 'green').setVelocityX(100)
    planet.setCircle(100) // set physics body as circle(rectangle by default)
    planet.setBounceY(Phaser.Math.FloatBetween(1, 1)) // bounce from ground
    planet.setBounceX(Phaser.Math.FloatBetween(1, 1)) // bounce from wall
    planet.setCollideWorldBounds(true)
    this.physics.add.collider(planet, ground)

    this.physics.add.overlap(cannon, planet, hitPlanet, null, this);

}

function update () {
    // var pointer = Phaser.scene.input.activePointer;
    // if (pointer.isDown) {
    //     var touchX = pointer.x;
    //     var touchY = pointer.y;
    //     // ...
    // }

    if (gameOver) return;

    this.input.on('pointerdown', () => {
        // console.log('pointer down')
    }, {});

    if (cursors.left.isDown) {
        cannon.setVelocityX(-260);
    }
    else if (cursors.right.isDown) {
        cannon.setVelocityX(260);
    }
    else {
        cannon.setVelocityX(0);
    }

    // pointer control
    this.input.on('pointermove', function (pointer) {

        if (pointer.isDown)
        {
            // this.add.image(pointer.x, pointer.y, 'balls', Phaser.Math.Between(0, 5));
            cannon.x = pointer.x
        }

    }, this);

    smoke.x = cannon.x;
    smoke.y = cannon.y - 70;
    smoke.visible = !smoke.visible
}

function hitPlanet () {
    this.physics.pause();
    gameOver = true;
}
</script>

</body>
</html>